#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
ê°€ê²© ë¹„êµ ë¦¬í¬íŠ¸ (ë¦¬íŒ©í† ë§)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¥ ìˆ˜ì •ì‚¬í•­:
  1. COLUMN_MAPì„ ê·¸ë£¹ë³„ë¡œ ì¬ì •ë ¬ â†’ ìƒìœ„í—¤ë” ë¶„ë¦¬ ë¬¸ì œ í•´ê²°
  2. í–‰ì—´ ê³ ì •ì„ ì½”ì–´ ì •ë³´ ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½ (C4)
"""

import sys
from pathlib import Path
from datetime import datetime

project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from src.data_manager import DataManager
from src.metrics.core import MetricsManager
from config.settings import Config

from analysis.excel import quick_build, ExcelRenderer


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Analysis Layer: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

def load_data():
    """ë°ì´í„° ë¡œë“œ"""
    dm = DataManager(Config.INTEGRATED_DB_PATH)
    metrics = MetricsManager(dm)
    
    df = metrics.get_view(
        metric_groups=['all'],
        n_latest=1,
        include_unmatched=True
    )
    
    if df.empty:
        return None
    
    # ì‹œê°„ì¶• suffix ì œê±° (ë‹¨ì¼ ìŠ¤ëƒ…ìƒ·)
    df.columns = [col.split('__')[0] if '__' in col else col for col in df.columns]
    
    return df


def define_column_map():
    """column_map ì •ì˜ - ğŸ”¥ ê·¸ë£¹ë³„ë¡œ ì™„ì „ ì •ë ¬
    
    ìˆœì„œ:
      1. ì½”ì–´ (6ê°œ): ë§¤ì¹­ìƒíƒœ, ì‹ ë¢°ë„, í’ˆë²ˆ, UPC, Product_ID, íŒë§¤ìƒíƒœ
      2. ì¹´í…Œê³ ë¦¬ (2ê°œ): ë¡œì¼“_ì¹´í…Œê³ ë¦¬, ì•„ì´í—ˆë¸Œ_ì¹´í…Œê³ ë¦¬
      3. ë§í¬ (2ê°œ): ë¡œì¼“_ë§í¬, ì•„ì´í—ˆë¸Œ_ë§í¬
      4. ìˆœìœ„ (1ê°œ): ìˆœìœ„
      5. íŒë§¤/ìœ„ë„ˆ (6ê°œ): íŒë§¤ëŸ‰, ë§¤ì¶œ, ì•„ì´í…œìœ„ë„ˆë¹„ìœ¨, ì¬ê³ , ë§¤ì¶œë¹„ì¤‘, íŒë§¤ëŸ‰ë¹„ì¤‘
      6. í• ì¸ì „ëµ (7ê°œ): ê°€ê²©ê²©ì°¨, ì†ìµë¶„ê¸°, ì¶”ì²œ, ìš”ì²­, ìœ ë¦¬í•œê³³, í• ì¸ìœ¨, ì¿ íŒ¡ì¶”ì²œê°€
      7. ì œí’ˆëª… (2ê°œ): ë¡œì¼“_ì œí’ˆëª…, ì•„ì´í—ˆë¸Œ_ì œí’ˆëª…
      8. ID (4ê°œ): ë¡œì¼“_Vendor, ë¡œì¼“_Item, ì•„ì´í—ˆë¸Œ_Vendor, ì•„ì´í—ˆë¸Œ_Item
      9. ê°€ê²©ìƒíƒœ (4ê°œ): ì •ê°€, ë¡œì¼“ê°€ê²©, íŒë§¤ê°€, ì •ê°€_ì•„ì´í—ˆë¸Œ
     10. í‰ê°€ (2ê°œ): í‰ì , ë¦¬ë·°ìˆ˜
    
    ì´ 36ê°œ ì»¬ëŸ¼
    """
    return {
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 1. ì½”ì–´ ì •ë³´ (6ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ë§¤ì¹­ìƒíƒœ': ('matching_status',),
        'ì‹ ë¢°ë„': ('matching_confidence',),
        'í’ˆë²ˆ': ('iherb_part_number',),
        'UPC': ('iherb_upc', 'Int64'),
        'Product_ID': ('rocket_product_id',),
        'íŒë§¤ìƒíƒœ': ('iherb_stock_status',),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 2. ì¹´í…Œê³ ë¦¬ (2ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ë¡œì¼“_ì¹´í…Œê³ ë¦¬': ('rocket_category',),
        'ì•„ì´í—ˆë¸Œ_ì¹´í…Œê³ ë¦¬': ('iherb_category',),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 3. ë§í¬ (2ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ë¡œì¼“_ë§í¬': ('rocket_url',),
        'ì•„ì´í—ˆë¸Œ_ë§í¬': ('iherb_url',),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 4. ìˆœìœ„ (1ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ìˆœìœ„': ('rocket_rank', 'Int64'),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 5. íŒë§¤/ìœ„ë„ˆ (6ê°œ) - ğŸ”¥ ëª¨ë‘ ëª¨ìŒ
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'íŒë§¤ëŸ‰': ('iherb_sales_quantity', 'Int64'),
        'ë§¤ì¶œ(ì›)': ('iherb_revenue', 'Int64'),
        'ì•„ì´í…œìœ„ë„ˆë¹„ìœ¨': ('iherb_item_winner_ratio',),
        'ì¬ê³ ': ('iherb_stock', 'Int64'),
        'ë§¤ì¶œë¹„ì¤‘': ('iherb_revenue', 'share'),
        'íŒë§¤ëŸ‰ë¹„ì¤‘': ('iherb_sales_quantity', 'share'),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 6. í• ì¸ì „ëµ (7ê°œ) - ğŸ”¥ ëª¨ë‘ ëª¨ìŒ
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ê°€ê²©ê²©ì°¨(ì›)': ('price_diff', 'Int64'),
        'ì†ìµë¶„ê¸°í• ì¸ìœ¨': ('breakeven_discount_rate',),
        'ì¶”ì²œí• ì¸ìœ¨': ('recommended_discount_rate',),
        'ìš”ì²­í• ì¸ìœ¨': ('requested_discount_rate',),
        'ìœ ë¦¬í•œê³³': ('cheaper_source',),
        'í• ì¸ìœ¨': ('rocket_discount_rate',),
        'ì¿ íŒ¡ì¶”ì²œê°€': ('iherb_recommended_price', 'Int64'),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 7. ì œí’ˆëª… (2ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ë¡œì¼“_ì œí’ˆëª…': ('rocket_product_name',),
        'ì•„ì´í—ˆë¸Œ_ì œí’ˆëª…': ('iherb_product_name',),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 8. ID (4ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ë¡œì¼“_Vendor': ('rocket_vendor_id',),
        'ë¡œì¼“_Item': ('rocket_item_id',),
        'ì•„ì´í—ˆë¸Œ_Vendor': ('iherb_vendor_id',),
        'ì•„ì´í—ˆë¸Œ_Item': ('iherb_item_id',),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 9. ê°€ê²©ìƒíƒœ (4ê°œ) - ğŸ”¥ ëª¨ë‘ ëª¨ìŒ
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ì •ê°€': ('rocket_original_price', 'Int64'),
        'ë¡œì¼“ê°€ê²©': ('rocket_price', 'Int64'),
        'íŒë§¤ê°€': ('iherb_price', 'Int64'),
        'ì •ê°€_ì•„ì´í—ˆë¸Œ': ('iherb_original_price', 'Int64'),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 10. í‰ê°€ (2ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'í‰ì ': ('rocket_rating',),
        'ë¦¬ë·°ìˆ˜': ('rocket_reviews', 'Int64'),
    }


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Main: ê·¹ë‹¨ì  ê°„ì†Œí™”
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

def main():
    """ë©”ì¸ ì›Œí¬í”Œë¡œìš°"""
    
    print(f"\n{'='*80}")
    print(f"ğŸ“Š ê°€ê²© ë¹„êµ ë¦¬í¬íŠ¸ ìƒì„± (ê·¸ë£¹ ì •ë ¬ ë²„ì „)")
    print(f"{'='*80}")
    
    # [1] ë°ì´í„° ë¡œë“œ
    print(f"\n[1/3] ë°ì´í„° ë¡œë“œ ì¤‘...")
    df = load_data()
    
    if df is None:
        print("âŒ ë°ì´í„° ì—†ìŒ")
        return
    
    print(f"âœ… {len(df):,}ê°œ ìƒí’ˆ ë¡œë“œ")
    
    # [2] column_map ì •ì˜
    print(f"\n[2/3] column_map ì •ì˜ ì¤‘...")
    column_map = define_column_map()
    print(f"âœ… {len(column_map)}ê°œ ì»¬ëŸ¼ ì •ì˜ (ê·¸ë£¹ë³„ ì •ë ¬)")
    
    # [3] ğŸ”¥ Excel Layerì— ëª¨ë‘ ìœ„ì„ + í–‰ì—´ ê³ ì • ì¡°ì •
    print(f"\n[3/3] Excel ìƒì„± ì¤‘...")
    config, output_df = quick_build(
        df, 
        column_map,
        freeze_panes=(4, 3)  # ğŸ”¥ C4 = ì½”ì–´ 2ê°œ ì»¬ëŸ¼ë§Œ ê³ ì •
    )
    
    Config.OUTPUT_DIR.mkdir(exist_ok=True)
    output_path = Config.OUTPUT_DIR / f"price_comparison_{datetime.now().strftime('%Y%m%d')}.xlsx"
    
    renderer = ExcelRenderer(str(output_path))
    result = renderer.render(output_df, config)
    
    if result['success']:
        print(f"\n{'='*80}")
        print(f"âœ… ì™„ë£Œ: {result['path']}")
        print(f"   {result['rows']:,}í–‰ Ã— {result['cols']}ì—´")
        print(f"\n   ğŸ“Œ ì£¼ìš” ê°œì„ ì‚¬í•­:")
        print(f"      âœ“ ê·¸ë£¹ë³„ ì™„ì „ ì •ë ¬ (ìƒìœ„í—¤ë” ë¶„ë¦¬ ë¬¸ì œ í•´ê²°)")
        print(f"      âœ“ í–‰ì—´ ê³ ì •: ì½”ì–´ ì •ë³´ ê¸°ì¤€ (C4)")
        print(f"      âœ“ ì»¬ëŸ¼ ë„ˆë¹„: ìë™ íŒ¨í„´ ë§¤ì¹­")
        print(f"{'='*80}\n")
    else:
        print(f"\nâŒ ì—ëŸ¬: {result['error']}")


if __name__ == "__main__":
    main()