#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
ê°€ê²© ë¹„êµ ë¦¬í¬íŠ¸ (ìµœì¢… ê°„ì†Œí™” ë²„ì „)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¥ í•µì‹¬ ì›ì¹™:
  1. ë³„ë„ í•¨ìˆ˜ ì •ì˜ ì—†ìŒ - ê¸°ì¡´ ëª¨ë“ˆ í•¨ìˆ˜ë§Œ í˜¸ì¶œ
  2. builders.pyì˜ íŒ¨í„´ ë§¤ì¹­ìœ¼ë¡œ ê·¸ë£¹ ìë™ ë¶„ë¥˜
  3. í• ì¸ìœ¨ â†’ ê°€ê²©ìƒíƒœ ê·¸ë£¹ (GROUP_PATTERNS ìˆ˜ì •ìœ¼ë¡œ í•´ê²°)
"""

import sys
from pathlib import Path
from datetime import datetime

project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from src.data_manager import DataManager
from src.metrics.core import MetricsManager
from config.settings import Config
from analysis.excel import quick_build, ExcelRenderer


def main():
    """ë©”ì¸ ì›Œí¬í”Œë¡œìš° - ëª¨ë“  ë¡œì§ í†µí•©"""
    
    print(f"\n{'='*80}")
    print(f"ğŸ“Š ê°€ê²© ë¹„êµ ë¦¬í¬íŠ¸ ìƒì„±")
    print(f"{'='*80}")
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # [1] ë°ì´í„° ë¡œë“œ
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    print(f"\n[1/3] ë°ì´í„° ë¡œë“œ ì¤‘...")
    
    dm = DataManager(Config.INTEGRATED_DB_PATH)
    metrics = MetricsManager(dm)
    
    df = metrics.get_view(
        metric_groups=['all'],
        n_latest=1,
        include_unmatched=True
    )
    
    if df.empty:
        print("âŒ ë°ì´í„° ì—†ìŒ")
        return
    
    # ì‹œê°„ì¶• suffix ì œê±° (ë‹¨ì¼ ìŠ¤ëƒ…ìƒ·)
    df.columns = [col.split('__')[0] if '__' in col else col for col in df.columns]
    
    print(f"âœ… {len(df):,}ê°œ ìƒí’ˆ ë¡œë“œ")
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # [2] column_map ì •ì˜ (ë°ì´í„° êµ¬ì¡°ë§Œ ì •ì˜, ê·¸ë£¹ì€ ìë™)
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    print(f"\n[2/3] column_map ì •ì˜ ì¤‘...")
    
    column_map = {
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 1. ì½”ì–´ ì •ë³´ (6ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ë§¤ì¹­ìƒíƒœ': ('matching_status',),
        'ì‹ ë¢°ë„': ('matching_confidence',),
        'í’ˆë²ˆ': ('iherb_part_number',),
        'UPC': ('iherb_upc', 'Int64'),
        'Product_ID': ('product_id',),  # ğŸ”¥ ê³µí†µ ID
        'íŒë§¤ìƒíƒœ': ('iherb_stock_status',),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 2. ì¹´í…Œê³ ë¦¬ (2ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ë¡œì¼“_ì¹´í…Œê³ ë¦¬': ('rocket_category',),
        'ì•„ì´í—ˆë¸Œ_ì¹´í…Œê³ ë¦¬': ('iherb_category',),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 3. ë§í¬ (2ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ë¡œì¼“_ë§í¬': ('rocket_url',),
        'ì•„ì´í—ˆë¸Œ_ë§í¬': ('iherb_url',),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 4. ìˆœìœ„ (1ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ìˆœìœ„': ('rocket_rank', 'Int64'),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 5. íŒë§¤/ìœ„ë„ˆ (6ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'íŒë§¤ëŸ‰': ('iherb_sales_quantity', 'Int64'),
        'ë§¤ì¶œ(ì›)': ('iherb_revenue', 'Int64'),
        'ì•„ì´í…œìœ„ë„ˆë¹„ìœ¨': ('iherb_item_winner_ratio',),
        'ì¬ê³ ': ('iherb_stock', 'Int64'),
        'ë§¤ì¶œë¹„ì¤‘': ('iherb_revenue', 'share'),
        'íŒë§¤ëŸ‰ë¹„ì¤‘': ('iherb_sales_quantity', 'share'),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 6. í• ì¸ì „ëµ (6ê°œ) - í• ì¸ìœ¨ ì œì™¸
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ê°€ê²©ê²©ì°¨(ì›)': ('price_diff', 'Int64'),
        'ì†ìµë¶„ê¸°í• ì¸ìœ¨': ('breakeven_discount_rate',),
        'ì¶”ì²œí• ì¸ìœ¨': ('recommended_discount_rate',),
        'ìš”ì²­í• ì¸ìœ¨': ('requested_discount_rate',),
        'ìœ ë¦¬í•œê³³': ('cheaper_source',),
        'ì¿ íŒ¡ì¶”ì²œê°€': ('iherb_recommended_price', 'Int64'),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 7. ì œí’ˆëª… (2ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ë¡œì¼“_ì œí’ˆëª…': ('rocket_product_name',),
        'ì•„ì´í—ˆë¸Œ_ì œí’ˆëª…': ('iherb_product_name',),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 8. ID (4ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ë¡œì¼“_Vendor': ('rocket_vendor_id',),
        'ë¡œì¼“_Item': ('rocket_item_id',),
        'ì•„ì´í—ˆë¸Œ_Vendor': ('iherb_vendor_id',),
        'ì•„ì´í—ˆë¸Œ_Item': ('iherb_item_id',),
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 9. ê°€ê²©ìƒíƒœ (6ê°œ) - ğŸ”¥ í• ì¸ìœ¨ í¬í•¨
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'ì •ê°€': ('rocket_original_price', 'Int64'),
        'ë¡œì¼“ê°€ê²©': ('rocket_price', 'Int64'),
        'ë¡œì¼“í• ì¸ìœ¨': ('rocket_discount_rate',),  # ğŸ”¥ builders.py íŒ¨í„´: "í• ì¸ìœ¨" â†’ "ê°€ê²©ìƒíƒœ"
        'íŒë§¤ê°€': ('iherb_price', 'Int64'),
        'ì •ê°€_ì•„ì´í—ˆë¸Œ': ('iherb_original_price', 'Int64'),
        'ì•„ì´í—ˆë¸Œí• ì¸ìœ¨': ('iherb_discount_rate',),  # ğŸ”¥ builders.py íŒ¨í„´: "í• ì¸ìœ¨" â†’ "ê°€ê²©ìƒíƒœ"
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 10. í‰ê°€ (2ê°œ)
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        'í‰ì ': ('rocket_rating',),
        'ë¦¬ë·°ìˆ˜': ('rocket_reviews', 'Int64'),
    }
    
    print(f"âœ… {len(column_map)}ê°œ ì»¬ëŸ¼ ì •ì˜")
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # [3] Excel ìƒì„± (Excel Layerì— ì „ë¶€ ìœ„ì„)
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    print(f"\n[3/3] Excel ìƒì„± ì¤‘...")
    
    config, output_df = quick_build(
        df, 
        column_map,
        freeze_panes=(3, 3)  # 2ë‹¨ í—¤ë”: C3
    )
    
    Config.OUTPUT_DIR.mkdir(exist_ok=True)
    output_path = Config.OUTPUT_DIR / f"price_comparison_{datetime.now().strftime('%Y%m%d')}.xlsx"
    
    renderer = ExcelRenderer(str(output_path))
    result = renderer.render(output_df, config)
    
    if result['success']:
        print(f"\n{'='*80}")
        print(f"âœ… ì™„ë£Œ: {result['path']}")
        print(f"   {result['rows']:,}í–‰ Ã— {result['cols']}ì—´")
        print(f"\n   ğŸ“Œ í•µì‹¬ ìˆ˜ì •:")
        print(f"      âœ“ Product_ID: ê³µí†µ ID ì‚¬ìš©")
        print(f"      âœ“ ë§¤ì¹­ìƒíƒœ: ë§¤ì¹­/ë¡œì¼“/ì•„ì´í—ˆë¸Œ")
        print(f"      âœ“ í• ì¸ìœ¨ â†’ ê°€ê²©ìƒíƒœ ê·¸ë£¹ (íŒ¨í„´ ë§¤ì¹­)")
        print(f"      âœ“ 2ë‹¨ í—¤ë” (ê°„ê²°)")
        print(f"{'='*80}\n")
    else:
        print(f"\nâŒ ì—ëŸ¬: {result['error']}")


if __name__ == "__main__":
    main()